name: Generate Issues from YAML Roadmap

permissions:
  contents: read
  issues: write

on:
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install yq and jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq

      #######################################################################
      # AUTO-DETECT PROJECT ID (USER â†’ ORG FALLBACK)
      #######################################################################
      - name: Auto-detect GitHub Project ID
        id: detect_project
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          PROJECT_NUMBER: 3
        run: |
          echo "Attempting USER project lookup..."
          USER_RESULT=$(gh api graphql -f query='
            query($owner: String!, $number: Int!) {
              user(login: $owner) {
                projectV2(number: $number) {
                  id
                }
              }
            }' -f owner="$OWNER" -F number="$PROJECT_NUMBER" 2>/dev/null || true)

          USER_ID=$(echo "$USER_RESULT" | jq -r '.data.user.projectV2.id // empty')

          if [ -n "$USER_ID" ]; then
            echo "Detected user project: $USER_ID"
            echo "project_id=$USER_ID" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "User project not found. Attempting ORG project lookup..."

          ORG_RESULT=$(gh api graphql -f query='
            query($owner: String!, $number: Int!) {
              organization(login: $owner) {
                projectV2(number: $number) {
                  id
                }
              }
            }' -f owner="$OWNER" -F number="$PROJECT_NUMBER" 2>/dev/null || true)

          ORG_ID=$(echo "$ORG_RESULT" | jq -r '.data.organization.projectV2.id // empty')

          if [ -n "$ORG_ID" ]; then
            echo "Detected organization project: $ORG_ID"
            echo "project_id=$ORG_ID" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "ERROR: Could not detect a ProjectV2 with number $PROJECT_NUMBER for owner $OWNER"
          exit 1

      #######################################################################
      # PARSE YAML AND CREATE ISSUES
      #######################################################################
      - name: Parse YAML and create issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PROJECT_ID: ${{ steps.detect_project.outputs.project_id }}
        run: |
          yq '.phases[]' .github/roadmap.yml | while read -r phase; do
            PHASE_NAME=$(echo "$phase" | yq '.name')

            echo "$phase" | yq '.items[]' | while read -r item; do
              TITLE=$(echo "$item" | yq '.title')
              DESCRIPTION=$(echo "$item" | yq '.description')
              STATUS=$(echo "$item" | yq '.status')

              BODY="### Description
              $DESCRIPTION

              ### Phase
              $PHASE_NAME

              ### Status
              $STATUS

            ---

            Generated automatically from roadmap.yml"

              # Skip if issue already exists
              if gh issue list --search "$TITLE" --json title | jq -e ".[] | select(.title==\"$TITLE\")" > /dev/null; then
                echo "Skipping existing issue: $TITLE"
                continue
              fi

              echo "Creating issue: $TITLE"

              ISSUE_URL=$(gh issue create \
                --title "$TITLE" \
                --body "$BODY" \
                --label "roadmap" \
                --label "$STATUS" \
                --label "$PHASE_NAME" \
                --json | jq -r '.url')

              ISSUE_ID=$(gh api "$ISSUE_URL" --jq '.node_id')

              #######################################################################
              # ADD ISSUE TO PROJECT
              #######################################################################
              gh api graphql -f query='
                mutation($project:ID!, $item:ID!) {
                  addProjectV2ItemById(input: {projectId: $project, contentId: $item}) {
                    item { id }
                  }
                }' -f project="$PROJECT_ID" -f item="$ISSUE_ID"

            done
          done